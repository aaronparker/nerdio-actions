<#
.SYNOPSIS
Installs the latest Microsoft PowerToys.

.DESCRIPTION
This script installs the latest version of Microsoft PowerToys. It requires the Microsoft .NET Runtime.

.PARAMETER Path
The download path for Microsoft PowerToys. The default path is "$Env:SystemDrive\Apps\Microsoft\PowerToys".

.NOTES
- This script requires the "Evergreen" module to be installed.
- The script disables certain features of PowerToys that are not suitable for VDI environments.
#>

#description: Installs the latest Microsoft PowerToys. Requires the Microsoft .NET Runtime
#execution mode: Combined
#tags: Evergreen, Microsoft, PowerToys
#Requires -Modules Evergreen
[System.String] $Path = "$Env:SystemDrive\Apps\Microsoft\PowerToys"

#region Script logic
New-Item -Path $Path -ItemType "Directory" -Force -ErrorAction "SilentlyContinue" | Out-Null
New-Item -Path "$Env:SystemRoot\Logs\ImageBuild" -ItemType "Directory" -Force -ErrorAction "SilentlyContinue" | Out-Null

Import-Module -Name "Evergreen" -Force
$App = Get-EvergreenApp -Name "MicrosoftPowerToys" | Where-Object { $_.Architecture -eq "x64" -and $_.InstallerType -eq "Default" } | Select-Object -First 1
$OutFile = Save-EvergreenApp -InputObject $App -CustomPath $Path -ErrorAction "Stop"

$LogFile = "$Env:SystemRoot\Logs\ImageBuild\MicrosoftPowerToys$($App.Version).log" -replace " ", ""
$params = @{
    FilePath     = $OutFile.FullName
    ArgumentList = "-silent -log $LogFile"
    NoNewWindow  = $true
    Wait         = $true
    PassThru     = $true
    ErrorAction  = "Stop"
}
Start-Process @params

# Disable features that aren't suitable for VDI
reg add "HKLM\Software\Policies\PowerToys" /v "AllowExperimentation" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityAwake" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityEnvironmentVariables" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityFileLocksmith" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityFileExplorerGcodePreview" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityFileExplorerGcodeThumbnails" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityHostsFileEditor" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityFileExplorerPDFPreview" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityFileExplorerPDFThumbnails" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityFileExplorerQOIPreview" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityFileExplorerQOIThumbnails" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityFileExplorerSTLThumbnails" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityFileExplorerSVGThumbnails" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityVideoConferenceMute" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "DisableNewUpdateAvailableToast" /d 1 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "AutomaticUpdateDownloadDisabled" /d 1 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "PerUserInstallationDisabled" /d 1 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "DoNotShowWhatsNewAfterUpdates" /d 1 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "SuspendNewUpdateAvailableToast" /d 1 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityCmdNotFound" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityPeek" /d 0 /t "REG_DWORD" /f | Out-Null
reg add "HKLM\Software\Policies\PowerToys" /v "ConfigureEnabledUtilityMouseWithoutBorders" /d 0 /t "REG_DWORD" /f | Out-Null

Start-Sleep -Seconds 5
Get-Process -ErrorAction "SilentlyContinue" | `
    Where-Object { $_.Path -like "$Env:ProgramFiles\PowerToys\*" } | `
    Stop-Process -Force -ErrorAction "SilentlyContinue"
#endregion
